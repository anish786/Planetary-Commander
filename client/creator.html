<!DOCTYPE html>
<html>
	<head>
	<title>Map Creator</title>

	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

	<link rel="stylesheet" href="/client/css/style.css" type="text/css" media="all" />
	
	<script src="/socket.io/socket.io.js"></script>
	<script src="http://code.createjs.com/easeljs-0.7.1.min.js"></script>
	
	<script src="/client/javascript/node.js"></script>
	<script>
		var small = 0;
		var medium = 1;
		var large = 2;
		
		var none = 0;
		var player = 1;
		var opponent = 2;
		
		var nodes = [];
		var lines = [];
		var selected = -1;
		
		var background = new createjs.Bitmap("/client/img/background1.png");
		
		var small_target = new createjs.Bitmap("/client/img/small_target.png");
		var medium_target = new createjs.Bitmap("/client/img/medium_target.png");
		var large_target = new createjs.Bitmap("/client/img/large_target.png");
		var visible_player_small_node = new createjs.Bitmap("/client/img/visible_small_player.png");
		var visible_player_medium_node = new createjs.Bitmap("/client/img/visible_medium_player.png");
		var visible_player_large_node = new createjs.Bitmap("/client/img/visible_large_player.png");
		var visible_opponent_small_node = new createjs.Bitmap("/client/img/visible_small_opponent.png");
		var visible_opponent_medium_node = new createjs.Bitmap("/client/img/visible_medium_opponent.png");
		var visible_opponent_large_node = new createjs.Bitmap("/client/img/visible_large_opponent.png");
		var visible_unowned_small_node = new createjs.Bitmap("/client/img/visible_small_unowned.png");
		var visible_unowned_medium_node = new createjs.Bitmap("/client/img/visible_medium_unowned.png");
		var visible_unowned_large_node = new createjs.Bitmap("/client/img/visible_large_unowned.png");
		var hidden_unknown_small_node = new createjs.Bitmap("/client/img/hidden_small_unknown.png");
		var hidden_unknown_medium_node = new createjs.Bitmap("/client/img/hidden_medium_unknown.png");
		var hidden_unknown_large_node = new createjs.Bitmap("/client/img/hidden_large_unknown.png");
		var hidden_opponent_small_node = new createjs.Bitmap("/client/img/hidden_small_opponent.png");
		var hidden_opponent_medium_node = new createjs.Bitmap("/client/img/hidden_medium_opponent.png");
		var hidden_opponent_large_node = new createjs.Bitmap("/client/img/hidden_large_opponent.png");
		
		var node_font = "20px Arial";
		var node_font_color = "#FFFFFF";
		
		var line_color = "#FFFFFF";
		
		var initialize = function() {
			stage = new createjs.Stage("pcgame");
			stage.addChild(background);
			stage.update();
			stage.enableMouseOver();
			stage.addEventListener("click", add_node)
		}
		
		var add_node = function(event) {
			var size = prompt("Size of the planet", "large, medium, or small");
			
			if (size == "large") {
				nodes.push(new node(large, event.stageX, event.stageY, []));
				nodes[nodes.length-1].update({units:20, owner:player, visible:true});
				if(selected == -1) {
					nodes[nodes.length-1].img.addEventListener("click", node_listener);
					nodes[nodes.length-1].img.addEventListener("mouseover", node_listener);
					nodes[nodes.length-1].img.addEventListener("mouseout", node_listener);
				}
				else {
					nodes[nodes.length-1].img.addEventListener("click", adjacent_listener);
					nodes[nodes.length-1].img.addEventListener("mouseover", adjacent_listener);
					nodes[nodes.length-1].img.addEventListener("mouseout", adjacent_listener);
				}
				stage.update();
			}
			else if (size == "medium") {
				nodes.push(new node(medium, event.stageX, event.stageY, []));
				nodes[nodes.length-1].update({units:10, owner:player, visible:true});
				if(selected == -1) {
					nodes[nodes.length-1].img.addEventListener("click", node_listener);
					nodes[nodes.length-1].img.addEventListener("mouseover", node_listener);
					nodes[nodes.length-1].img.addEventListener("mouseout", node_listener);
				}
				else {
					nodes[nodes.length-1].img.addEventListener("click", adjacent_listener);
					nodes[nodes.length-1].img.addEventListener("mouseover", adjacent_listener);
					nodes[nodes.length-1].img.addEventListener("mouseout", adjacent_listener);
				}
				stage.update();
			}
			else if (size == "small") {
				nodes.push(new node(small, event.stageX, event.stageY, []));
				nodes[nodes.length-1].update({units:5, owner:player, visible:true});
				if(selected == -1) {
					nodes[nodes.length-1].img.addEventListener("click", node_listener);
					nodes[nodes.length-1].img.addEventListener("mouseover", node_listener);
					nodes[nodes.length-1].img.addEventListener("mouseout", node_listener);
				}
				else {
					nodes[nodes.length-1].img.addEventListener("click", adjacent_listener);
					nodes[nodes.length-1].img.addEventListener("mouseover", adjacent_listener);
					nodes[nodes.length-1].img.addEventListener("mouseout", adjacent_listener);
				}
				stage.update();
			}
		}
		
		var node_listener = function(event) {
			if(event.type == "click") {
				for(var i = 0; i < nodes.length; i++) {
					nodes[i].img.removeEventListener("click", node_listener);
					nodes[i].img.removeEventListener("mouseover", node_listener);
					nodes[i].img.removeEventListener("mouseout", node_listener);
				}
				selected = event.currentTarget.node_id;
				nodes[selected].show_target();
				
				nodes[selected].img.addEventListener("click", adjacent_listener);
				
				for(var i = 0; i < nodes.length; i++){
					if (i != selected) {
						nodes[i].img.addEventListener("click", adjacent_listener);
						nodes[i].img.addEventListener("mouseover", adjacent_listener);
						nodes[i].img.addEventListener("mouseout", adjacent_listener);
					}
				}
				event.stopPropagation();
			}
			else if(event.type == "mouseover") {
				var hover = event.currentTarget.node_id;
				nodes[hover].show_target();
				stage.update();
			}
			else if(event.type == "mouseout") {
				var hover = event.currentTarget.node_id;
				nodes[hover].hide_target();
				stage.update();
			}
		}
		
		var adjacent_listener = function(event) {
			var adjacent = event.currentTarget.node_id;
			if(adjacent != selected) {
				if(event.type == "click") {
					for(var i = 0; i < nodes.length; i++) {
						nodes[i].img.removeEventListener("click", adjacent_listener);
						nodes[i].img.removeEventListener("mouseover", adjacent_listener);
						nodes[i].img.removeEventListener("mouseout", adjacent_listener);
						nodes[i].img.addEventListener("click", node_listener);
						nodes[i].img.addEventListener("mouseover", node_listener);
						nodes[i].img.addEventListener("mouseout", node_listener);
					}
					var already_adjacent = false;
					for(var i = 0; i < nodes[selected].adjacent.length; i++) {
						if(nodes[selected].adjacent[i] == adjacent) {
							already_adjacent = true;
							break;
						}
					}
					
					if(!already_adjacent) {
						nodes[selected].adjacent.push(adjacent);
						nodes[adjacent].adjacent.push(selected);
						
						lines.push(new createjs.Shape());
						lines[lines.length-1].graphics.setStrokeStyle(1).beginStroke(line_color).moveTo(nodes[selected].x, nodes[selected].y).lineTo(nodes[adjacent].x, nodes[adjacent].y).endStroke();
						stage.addChildAt(lines[lines.length-1], 1);
					}
					
					nodes[selected].hide_target();
					selected = -1;
					event.stopPropagation();
				}
				else if(event.type == "mouseover") {
					var hover = event.currentTarget.node_id;
					nodes[hover].show_target();
				}
				else if(event.type == "mouseout") {
					var hover = event.currentTarget.node_id;
					nodes[hover].hide_target();
				}
			}
			else {
				nodes[selected].hide_target();
				selected = -1;
				for(var i = 0; i < nodes.length; i++) {
					nodes[i].img.removeEventListener("click", adjacent_listener);
					nodes[i].img.removeEventListener("mouseover", adjacent_listener);
					nodes[i].img.removeEventListener("mouseout", adjacent_listener);
					nodes[i].img.addEventListener("click", node_listener);
					nodes[i].img.addEventListener("mouseover", node_listener);
					nodes[i].img.addEventListener("mouseout", node_listener);
				}
				event.stopPropagation();
			}
			stage.update();
		}
		
		var generate_code = function(){
			var client_side = "create_nodes.push (function() {\n";
			var server_side = "maps.push(function(game_id) {\n";
			
			for(var i = 0; i < nodes.length; i++) {
				client_side = client_side + "\tnodes.push(new node("
				server_side = server_side + "\tnodes[game_id].push(new node(" + nodes[i].units + ", ";
				if(nodes[i].size == large){
					client_side = client_side + "large, ";
					server_side = server_side + "large, ";
				}
				else if (nodes[i].size == medium) {
					client_side = client_side + "medium, ";
					server_side = server_side + "medium, ";
				}
				else if (nodes[i].size == small) {
					client_side = client_side + "small, ";
					server_side = server_side + "small, ";
				}
				
				client_side = client_side + nodes[i].x + ", " + nodes[i].y + ", [";
				server_side = server_side + "[";
				
				for(var j = 0; j < nodes[i].adjacent.length; j++) {
					if(j != 0){
						client_side = client_side + ", " + nodes[i].adjacent[j];
						server_side = server_side + ", " + nodes[i].adjacent[j];
					}
					else {
						client_side = client_side + nodes[i].adjacent[j];
						server_side = server_side + nodes[i].adjacent[j];
					}
				}
				client_side = client_side + "]));\n";
				server_side = server_side + "]));\n";
			}
			client_side = client_side + "})";
			server_side = server_side + "\n\t//Include Player Starts here\n})";
			
			console.log("Client Side Code:\n" + client_side);
			console.log("\nServer Side Code:\n" +server_side);
		}
	</script>
	
	</head>
	<body onLoad="initialize();">
		<canvas id="pcgame" width="1000" height="700"></canvas>	
	</body>
</html>